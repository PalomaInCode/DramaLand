<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="shortcut icon"
      href="./assets/logo-navegador.png"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="css/style.css" />
    <title>The Dorama Awards</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body onload="obterDadosGrafico()">
    <header>
      <a href="index.html">
        <img class="logo" src="assets/logo.png" alt="Logo DramaLand" width="200px" />
      </a>
      <nav>
        <ul>
          <li><a href="index.html" class="active">Início</a></li>
          <li>
            <a href="categorias.html">Categorias</a>
            <div class="dropdown">
              <a href="acao.html">Ação</a>
              <a href="comedia.html">Comédia</a>
              <a href="drama.html">Drama</a>
              <a href="fantasia.html">Fantasia</a>
              <a href="historico.html">Histórico</a>
              <a href="misterio.html">Mistério & Suspense</a>
              <a href="romance.html">Romance</a>
              <a href="ficcao.html">Ficção</a>
            </div>
          </li>
          <li><a href="sobre.html">Sobre</a></li>
          <li id="loginLink"><a href="login.html">Login</a></li>
          <li id="cadastroLink"><a href="cadastro.html">Cadastro</a></li>
          <li id="quizLink" style="display: none;"><a href="quiz.html">Quiz</a></li>
          <li id="perfilLink" style="display: none;"><a href="perfil.html">Perfil</a></li>
          <li id="sairLink" style="display: none;"><a href="login.html" onclick="sair()">Sair</a></li>
        </ul>
      </nav>
    </header>

    <div class="titulos">
      <h1>MELHORES DORAMAS</h1>
    </div>

    <div class="doramas-concorrentes">
      <div class="dorama" onclick="votar('It’s Okay to Not Be Okay')">
        <img
          src="assets/acao.png"
          alt="It’s Okay to Not Be Okay"
          width="200px"
          height="300px"
        />
        <p>IT’S OKAY TO NOT BE OKAY</p>
      </div>
      <div class="dorama" onclick="votar('Hospital Playlist')">
        <img
          src="assets/acao.png"
          alt="Hospital Playlist"
          width="200px"
          height="300px"
        />
        <p>HOSPITAL PLAYLIST</p>
      </div>
      <div class="dorama" onclick="votar('Beautiful World')">
        <img
          src="assets/acao.png"
          alt="Beautiful World"
          width="200px"
          height="300px"
        />
        <p>BEAUTIFUL WORLD</p>
      </div>
      <div class="dorama" onclick="votar('Extraordinary Attorney Woo')">
        <img
          src="assets/acao.png"
          alt="Extraordinary Attorney Woo"
          width="200px"
          height="300px"
        />
        <p>EXTRAORDINARY ATTORNEY WOO</p>
      </div>
      <div class="dorama" onclick="votar('Round 6')">
        <img
          src="assets/acao.png"
          alt="Round 6"
          width="200px"
          height="300px"
        />
        <p>ROUND 6</p>
      </div>
      <div class="dorama" onclick="votar('Sweet Home')">
        <img
          src="assets/acao.png"
          alt="Sweet Home"
          width="200px"
          height="300px"
        />
        <p>SWEET HOME</p>
      </div>
    </div>

    <div class="grafico-e-kpis">
      <!-- Gráfico -->
      <div class="grafico">
        <canvas id="myCanvas"></canvas>
      </div>
      
      
      <!-- KPIs dentro da caixa do gráfico -->
      <div class="kpis">
        <div class="kpi">
          <h2>Votos Totais</h2>
          <p id="totalVotes">0</p>
        </div>
        <div class="kpi">
          <h2>Votos do Vencedor</h2>
          <p id="winnerVotes">0</p>
        </div>
        <div class="kpi">
          <h2>Favoritismo do Vencedor</h2>
          <p id="winnerPercentage">0%</p>
        </div>
        <div class="kpi">
          <h2>Dorama com Mais Votos</h2>
          <p id="topDorama">winnerName</p> <!-- Novo campo para o nome do dorama -->
        </div>
      </div>
    </div>
    
    
    
<script>
let myChart;

function votar(nomeDorama) {
  fetch(`/votos/votar/${nomeDorama}`, {
    method: "POST",
  })
    .then((response) => {
      if (response.ok) {
        console.log("Voto contabilizado");
        atualizarGrafico();
      } else {
        console.error("Erro na votação ou dorama não encontrado");
      }
    })
    .catch(function (error) {
      console.error(`Erro ao realizar o voto: ${error.message}`);
    });
}

function obterDadosGrafico() {
  fetch("/votos/ultimos", { cache: "no-store" })
    .then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          plotarGrafico(resposta);
          calcularKpis(resposta);  // Atualizando as KPIs após os dados do gráfico serem carregados
        });
      } else {
        console.error("Nenhum dado encontrado ou erro na API");
      }
    })
    .catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}

function plotarGrafico(resposta) {
  console.log("iniciando plotagem do gráfico...");

  // Criando estrutura para plotar gráfico de doramas
  let labels = [
    "It’s Okay to Not Be Okay",
    "Hospital Playlist",
    "Beautiful World",
    "Extraordinary Attorney Woo",
    "Round 6",
    "Sweet Home",
  ];

  let dados = {
    labels: labels,
    datasets: [
      {
        label: "Votos por Dorama",
        data: [],
        fill: false,
        backgroundColor: [
          "rgba(249, 168, 212, 0.2)", // #f9a8d4
          "rgba(245, 93, 158, 0.2)",  // #f55d9e
          "rgba(241, 196, 212, 0.2)", // #f1c4d4
          "rgba(242, 166, 198, 0.2)", // #f2a6c6
          "rgba(237, 31, 144, 0.2)",  // #ed1f90
        ],
        borderColor: [
          "rgba(249, 168, 212, 1)",  // #f9a8d4
          "rgba(245, 93, 158, 1)",   // #f55d9e
          "rgba(241, 196, 212, 1)",  // #f1c4d4
          "rgba(242, 166, 198, 1)",  // #f2a6c6
          "rgba(237, 31, 144, 1)",   // #ed1f90
        ],
        borderWidth: 1,
        tension: 0.1,
      },
    ],
  };

  // Inserindo valores dos votos por dorama
  for (let i = 0; i < resposta.length; i++) {
    var registro = resposta[i];
    dados.datasets[0].data.push(registro.quantidade);
  }

  // Configuração do gráfico de doramas
  const config = {
    type: "bar",
    data: dados,
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
        },
      },
      plugins: {
        title: {
          display: true,
          text: "VOTAÇÃO POR DORAMA",
          color: "#333",
          font: {
            size: 20,
          },
        },
        legend: {
          display: true,
          labels: {
            color: "#333",
          },
        },
      },
    },
  };

  // Adicionando gráfico de doramas
  myChart = new Chart(document.getElementById("myCanvas"), config);

  // Agora, vamos criar o gráfico de gênero
  plotarGraficoGenero(resposta);
}

function plotarGraficoGenero(resposta) {
  let generos = {}; // Objeto para contar os votos por gênero

  // Associar os gêneros dos doramas
  const generosDorama = {
    "It’s Okay to Not Be Okay": "Drama",
    "Hospital Playlist": "Comédia",
    "Beautiful World": "Drama",
    "Extraordinary Attorney Woo": "Comédia",
    "Round 6": "Ação",
    "Sweet Home": "Terror",
  };

  // Contabilizar os votos por gênero
  resposta.forEach((registro) => {
    const genero = generosDorama[registro.nomeDorama];
    if (generos[genero]) {
      generos[genero] += registro.quantidade;
    } else {
      generos[genero] = registro.quantidade;
    }
  });

  // Criar os dados para o gráfico de gênero
  let labelsGenero = Object.keys(generos);
  let votosGenero = Object.values(generos);

  // Configuração do gráfico de gênero
  const configGenero = {
    type: "bar",
    data: {
      labels: labelsGenero,
      datasets: [{
        label: "Votos por Gênero",
        data: votosGenero,
        backgroundColor: [
          "rgba(252, 99, 132, 0.2)",
          "rgba(85, 99, 255, 0.2)",
          "rgba(253, 177, 72, 0.2)",
          "rgba(48, 204, 89, 0.2)"
        ],
        borderColor: [
          "rgba(252, 99, 132, 1)",
          "rgba(85, 99, 255, 1)",
          "rgba(253, 177, 72, 1)",
          "rgba(48, 204, 89, 1)"
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
        }
      },
      plugins: {
        title: {
          display: true,
          text: "VOTOS POR GÊNERO",
          color: "#333",
          font: {
            size: 20,
          },
        },
        legend: {
          display: false,
        }
      }
    }
  };

  // Adicionando gráfico de gênero
  let myChartGenero = new Chart(document.getElementById("myCanvasGenero"), configGenero);
}

function atualizarGrafico() {
  fetch("/votos/ultimos", { cache: "no-store" })
    .then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then(function (respostaJSON) {
          console.log(`Dados recebidos: ${JSON.stringify(respostaJSON)}`);
          console.log("Dados atuais do gráfico:");

          myChart.data.datasets[0].data = [];

          for (let i = 0; i < respostaJSON.length; i++) {
            myChart.data.datasets[0].data.push(respostaJSON[i].quantidade);
          }

          myChart.update();
          calcularKpis(respostaJSON);  // Atualiza as KPIs com os novos dados do gráfico
        });
      } else {
        console.error("Nenhum dado encontrado ou erro na API");
      }
    })
    .catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}

function calcularKpis(resposta) {
  let totalVotos = 0;
  let votosVencedor = 0;
  let nomeVencedor = "";

  for (let i = 0; i < resposta.length; i++) {
    totalVotos += resposta[i].quantidade;

    // Verificar se esse dorama tem mais votos que o atual vencedor
    if (resposta[i].quantidade > votosVencedor) {
      votosVencedor = resposta[i].quantidade;
      nomeVencedor = resposta[i].dorama; // Correção na atribuição do nome do vencedor
    }
  }

  // Calcular a porcentagem do vencedor
  let percentualVencedor = totalVotos > 0 ? ((votosVencedor / totalVotos) * 100).toFixed(2) : 0;

  // Atualizar as KPIs na página
  document.getElementById("totalVotes").textContent = totalVotos;
  document.getElementById("winnerVotes").textContent = nomeVencedor ? `${nomeVencedor}: ${votosVencedor}` : 'Sem votos';
  document.getElementById("winnerPercentage").textContent = `${percentualVencedor}%`;
  document.getElementById("topDorama").textContent = nomeVencedor ? nomeVencedor : 'Nenhum vencedor';
}

</script>
